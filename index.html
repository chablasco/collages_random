<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CB Screenplay Pictures</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
<script>
  let cutouts = [];
  const mag = 1000;
  const amount = 3;

  let filenames = [
    "assets/0.jpg", "assets/1.jpg", "assets/2.jpg", "assets/3.jpg", "assets/4.jpg",
    "assets/5.jpg", "assets/6.jpg", "assets/7.jpg", "assets/8.jpg", "assets/9.jpg",
    "assets/10.jpg", "assets/11.jpg", "assets/12.jpg", "assets/13.jpg", "assets/14.jpg",
    "assets/15.jpg", "assets/16.jpg", "assets/17.jpg", "assets/18.jpg", "assets/19.jpg",
    "assets/20.jpg", "assets/21.jpg", "assets/23.jpg", "assets/24.jpg", "assets/25.jpg",
    "assets/26.jpg", "assets/27.jpg", "assets/28.jpg", "assets/29.jpg", "assets/30.jpg"
  ];

  let loadedImages = [];

  function preload() {
    for (let path of filenames) {
      loadedImages.push(loadImage(path, img => img, err => console.warn(`Image load failed: ${path}`)));
    }
  }

  function setup() {
    createCanvas(windowWidth, windowHeight);
    generateCutouts();
  }

  function draw() {
    background(0);
    for (let c of cutouts) {
      c.display();
    }
  }

  function generateCutouts() {
    cutouts = [];
    for (let img of loadedImages) {
      if (img) {
        cutouts.push(new Cutout(img));
      }
    }
  }

  class Cutout {
  constructor(img) {
    this.imgOriginal = img;
    this.img = img.get();
    this.img.resize(width, height);
    this.pg = createGraphics(width, height);
    this.amount = amount;
    this.speed = random(0.001, 0.005); // very slow for smoothness
    this.rotation = random(TWO_PI); // initial rotation
    this.targetRotation = this.rotation;
    this.xs = [];
    this.ys = [];

    for (let i = 0; i < this.amount; i++) {
      this.xs.push(random(-mag, mag));
      this.ys.push(random(-mag, mag));
    }
  }

  display() {
    // Smooth rotation update
    this.targetRotation = sin(millis() * this.speed) * PI;
    this.rotation = lerp(this.rotation, this.targetRotation, 0.05);

    this.pg.clear();
    this.pg.push();
    this.pg.translate(width / 2, height / 2);
    this.pg.rotate(this.rotation);

    this.pg.noStroke();
    this.pg.fill(255);
    this.pg.beginShape();
    for (let i = 0; i < this.amount; i++) {
      let offsetX = this.xs[i] + sin(millis() * 0.001 + i) * 50;
      let offsetY = this.ys[i] + cos(millis() * 0.0012 + i) * 50;
      this.pg.curveVertex(offsetX, offsetY);
    }
    this.pg.endShape(CLOSE);
    this.pg.pop();

    let maskImg = createImage(width, height);
    maskImg.copy(this.pg, 0, 0, width, height, 0, 0, width, height);
    maskImg.filter(GRAY);

    let masked = this.img.get();
    masked.mask(maskImg);
    image(masked, 0, 0);
  }
}

  function keyPressed() {
    if (key === 'r' || key === 'R') {
      generateCutouts();
    }
    if (key === 's' || key === 'S') {
      saveCanvas('cb_collage_composition', 'png');
    }
  }

  function windowResized() {
    resizeCanvas(windowWidth, windowHeight);
    generateCutouts();
  }

  function mousePressed() {
    fullscreen(!fullscreen());
  }
</script>
</body>
</html>
